# Import Service (`backend/services/import`)

## Назначение

`import` отвечает за импорт и экспорт колод:
- прием внешних форматов;
- превью и маппинг полей;
- фоновая обработка;
- запись результата в `core`.

## Главные фичи

- загрузка файлов импорта (через media);
- preview endpoint перед запуском импорта;
- import jobs и export jobs с трекингом прогресса;
- импорт из `APKG/CSV/TSV/TXT`;
- экспорт колод в CSV (фоновой задачей).

## Технологии

- Java 21 + Spring Boot 3.5;
- Spring Security Resource Server;
- Spring Data JPA + PostgreSQL + Flyway;
- Apache Commons CSV;
- SQLite JDBC + zstd (для APKG-пайплайна);
- Scheduler/worker на стороне сервиса;
- Actuator + Prometheus.

## Технические решения и паттерны

- Job queue в БД (`import_jobs`) вместо отдельного брокера для простоты эксплуатации.
- Воркер-процессинг с конкурентной блокировкой `FOR UPDATE SKIP LOCKED`.
- Parser factory по source type.
- Превью до импорта как механизм снижения ошибок маппинга.
- Асинхронная модель обработки для больших файлов и долгих задач.

## Связь с другими сервисами

- Валидирует JWT от `auth`.
- Использует `media` для хранения исходных/результирующих файлов.
- Использует `core` для создания/обновления колод и карточек после разбора.
- Вызывается фронтендом из модального workflow импорта.

