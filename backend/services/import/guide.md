# Import Service Guide

## Кратко
Сервис импорта и экспорта колод. Принимает файлы (APKG/CSV/TSV/TXT), показывает превью, запускает фоновую обработку и создает/мерджит карты в core. Экспортирует колоду в CSV и возвращает файл через media.

## Основные функции
- Загрузка файла импорта (multipart upload через media internal).
- Превью: список полей, пример карт, автосопоставление полей.
- Фоновая обработка импорта (job queue в БД).
- Импорт прогресса обучения из APKG (минимальный перенос).
- Экспорт в CSV (zip) через фоновую задачу.

## Данные и сущности
Работает с таблицей `app_import.import_jobs`.
Главные сущности:
- `ImportJobEntity` — задача импорта/экспорта и ее статус.
- `ImportJobType` — `import_job` / `export_job`.
- `ImportSourceType` — `apkg`, `csv`, `tsv`, `txt`.
- `ImportMode` — `create_new`, `merge_into_existing`.

Важные поля задачи:
- `source_media_id` — файл импорта в media.
- `target_deck_id` — целевая колода для мерджа.
- `field_mapping` — сопоставление полей.
- `total_items` / `processed_items` — прогресс.

## Почему так
- Очередь в БД: проще деплой, не нужен отдельный брокер, можно масштабировать воркеры.
- Превью перед импортом: снижает риск "сломать" колоду.
- Медиа через media-service: единые правила валидации, размеры и S3 ключи в одном месте.
- Импорт прогресса: переносим знания пользователя, но не привязываемся к алгоритму Anki.

## Фишки/паттерны
- Background worker с `FOR UPDATE SKIP LOCKED` — безопасный параллельный разбор.
- Парсеры по формату (`ImportParserFactory`).
- Стриминг медиа из APKG без загрузки всего файла в память.

## Что может пользователь
- Импортировать новую колоду из APKG/CSV/TSV/TXT.
- Слить импорт в существующую колоду с выбором сопоставления полей.
- Экспортировать колоду в CSV.
