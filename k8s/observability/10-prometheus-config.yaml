apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-config
  namespace: observability
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    scrape_configs:
      - job_name: prometheus
        static_configs:
          - targets: ["localhost:9090"]

      - job_name: kube-state-metrics
        static_configs:
          - targets: ["kube-state-metrics.observability.svc.cluster.local:8080"]

      - job_name: node-exporter
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - source_labels: [__meta_kubernetes_node_address_InternalIP]
            regex: (.+)
            target_label: __address__
            replacement: $1:9100
          - source_labels: [__meta_kubernetes_node_name]
            target_label: instance

      - job_name: kubelet
        scheme: https
        metrics_path: /metrics
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        tls_config:
          insecure_skip_verify: true
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - source_labels: [__meta_kubernetes_node_name]
            target_label: instance

      - job_name: cadvisor
        scheme: https
        metrics_path: /metrics/cadvisor
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        tls_config:
          insecure_skip_verify: true
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - source_labels: [__meta_kubernetes_node_name]
            target_label: instance

      - job_name: mnema-auth
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["prod"]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: mnema-auth
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8080"
            action: keep
          - target_label: __metrics_path__
            replacement: /actuator/prometheus
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      - job_name: mnema-core
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["prod"]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: mnema-core
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8080"
            action: keep
          - target_label: __metrics_path__
            replacement: /api/core/actuator/prometheus
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      - job_name: mnema-user
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["prod"]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: mnema-user
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8080"
            action: keep
          - target_label: __metrics_path__
            replacement: /api/user/actuator/prometheus
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      - job_name: mnema-media
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["prod"]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: mnema-media
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8080"
            action: keep
          - target_label: __metrics_path__
            replacement: /api/media/actuator/prometheus
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      - job_name: mnema-import
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["prod"]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: mnema-import
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8080"
            action: keep
          - target_label: __metrics_path__
            replacement: /api/import/actuator/prometheus
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod

      - job_name: mnema-ai
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ["prod"]
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            regex: mnema-ai
            action: keep
          - source_labels: [__meta_kubernetes_pod_container_port_number]
            regex: "8080"
            action: keep
          - target_label: __metrics_path__
            replacement: /api/ai/actuator/prometheus
          - source_labels: [__meta_kubernetes_pod_label_app]
            target_label: app
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
